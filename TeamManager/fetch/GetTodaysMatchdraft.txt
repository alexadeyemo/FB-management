<?php
session_start();
header('Content-Type: application/json');

$database = new SQLite3('../fb_managment_system.db');

$user_id = $_SESSION['user_id'] ?? null;
if (!$user_id) {
    echo json_encode(['error' => 'User not logged in']);
    exit;
}

// Get the team managed by this user
$teamStmt = $database->prepare("SELECT Team_ID FROM Team WHERE Manager_ID = :user_id");
$teamStmt->bindValue(':user_id', $user_id, SQLITE3_TEXT);
$teamResult = $teamStmt->execute()->fetchArray(SQLITE3_ASSOC);

if (!$teamResult) {
    echo json_encode(['error' => 'No team found for manager']);
    exit;
}

$team_id = $teamResult['Team_ID'];
$query =   "SELECT m.Match_Date, t1.team_name AS TeamA, t2.team_name AS TeamB
            FROM Match m
            JOIN Team t1 ON m.TeamA_ID = t1.Team_ID
            JOIN Team t2 ON m.TeamB_ID = t2.Team_ID
            WHERE date(m.Match_Date) = date('now')
            AND (m.TeamA_ID = :team_id OR m.TeamB_ID = :team_id)
            LIMIT 1";

// Get today's match
$matchStmt = $database->query($query);    
$matchStmt->bindValue(':team_id', $team_id, SQLITE3_INTEGER);
$result = $matchStmt->execute()->fetchArray(SQLITE3_ASSOC);

if ($result) {
    echo json_encode($result);
} else {
    echo json_encode(['message' => 'No match today']);
}
?>
